<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prabha Graphics — Orders (Admin)</title>

  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#D10007;
      --primary-dark:#A00006;
      --muted:#6b7280;
      --bg:#f9fafb;
      --card-bg:#ffffff;
      --border:#e5e7eb;
      --shadow-soft:0 10px 30px rgba(15,23,42,0.06);
      --max-width:1280px;
      --radius:12px;
      --gap:12px;
      --nav-height:80px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Poppins',sans-serif;
      background:linear-gradient(180deg,#fff,#fbfbfd);
      color:#111827;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-top:var(--nav-height);
    }
    a{text-decoration:none;color:inherit}

    /* ---------------- HEADER (homepage style) ---------------- */
    .navbar{
      position:fixed;top:0;left:0;right:0;
      z-index:1000;
      background-color:#ffffff;
      transition:all 0.3s ease;
      box-shadow:0 6px 18px rgba(15,23,42,0.04);
    }
    .nav-container{
      max-width:1280px;
      margin:0 auto;
      padding:16px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .nav-logo{display:flex;align-items:center;gap:8px;cursor:pointer;transition:transform 0.3s}
    .nav-logo:hover{transform:scale(1.02)}
    .logo-img{width:44px;height:44px;border-radius:999px;object-fit:contain;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}
    .logo-text{font-weight:700;font-size:20px;color:#111827}
    .nav-links{display:flex;gap:20px;list-style:none;align-items:center}
    .nav-link{color:#111827;text-decoration:none;font-weight:600;position:relative;padding-bottom:3px}
    .nav-link::after{content:'';position:absolute;bottom:-4px;left:0;width:0;height:2px;background-color:var(--primary);transition:width .25s}
    .nav-link:hover::after{width:100%}
    .cta-btn{background-color:var(--primary);color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-weight:700}
    .hamburger{display:none}
    @media(max-width:768px){
      .nav-links{display:none}
      .hamburger{display:flex;flex-direction:column;gap:4px;cursor:pointer}
      .hamburger span{width:22px;height:3px;background:#111;border-radius:2px}
    }

    /* ---------------- PAGE LAYOUT ---------------- */
    .page{max-width:var(--max-width);margin:20px auto 40px;padding:0 20px;display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media(max-width:1100px){ .page{grid-template-columns:1fr 320px} }
    @media(max-width:900px){ .page{grid-template-columns:1fr;margin-top:28px;padding:0 14px} }

    .card{background:var(--card-bg);border-radius:var(--radius);box-shadow:var(--shadow-soft);padding:16px;border:1px solid rgba(148,163,184,0.08)}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px;flex-wrap:wrap}
    .title{font-size:16px;font-weight:700}
    .sub{font-size:13px;color:var(--muted)}

    /* AUTH STRIP */
    .auth-strip{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .auth-input{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#f9fafb}
    .btn-auth{border-radius:999px;padding:8px 12px;border:none;cursor:pointer;font-weight:600}
    .btn-auth.primary{background:var(--primary);color:#fff}
    .btn-auth.secondary{background:#eef2f5;color:#111}

    /* FILTER BAR */
    .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .filters input[type=text], .filters select, .filters input[type=date]{
      padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:13px;
      min-width:140px;
    }
    .filters .small{min-width:110px}

    /* TABLE (desktop) */
    .table-wrap{overflow:auto;border-radius:8px;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{background:#fbfbfd;padding:10px 12px;text-align:left;border-bottom:1px solid var(--border);font-weight:700;position:sticky;top:0;z-index:2}
    tbody td{padding:12px;border-bottom:1px solid #f3f4f6;vertical-align:top}
    tbody tr:hover{background:#fff7f7}
    .status-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px}
    .status-pending{background:#fff7ed;color:#92400e;border:1px solid #fde68a}
    .status-processing{background:#eef2ff;color:#1e3a8a;border:1px solid #bfdbfe}
    .status-shipped{background:#ecfdf5;color:#064e3b;border:1px solid #bbf7d0}
    .status-completed{background:#f0fdf4;color:#065f46;border:1px solid #bbf7d0}

    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .btn.small{padding:6px 8px;font-size:12px;border-radius:8px}

    /* CARDS (mobile) */
    .cards-grid{display:none;gap:12px}
    .order-card{border-radius:12px;padding:12px;border:1px solid var(--border);background:#fff;box-shadow:var(--shadow-soft)}
    .order-top{display:flex;justify-content:space-between;gap:8px;align-items:flex-start;flex-wrap:wrap}
    .order-left{flex:1}
    .order-right{text-align:right;min-width:110px}

    /* DETAIL modal */
    .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:150;padding:18px}
    .modal{width:100%;max-width:900px;background:#fff;border-radius:12px;overflow:auto;max-height:92vh;padding:16px;border:1px solid var(--border)}
    .modal .meta{font-size:13px;color:var(--muted);margin-top:6px}

    /* RIGHT PANEL */
    .panel-scroll{max-height:72vh;overflow:auto;padding-right:6px}
    .panel-section{margin-bottom:12px}

    /* THANK YOU POPUP (used for Option A — popup replaces redirect) */
    .thank-modal .box{
      background:#fff;padding:22px;border-radius:14px;max-width:520px;width:100%;text-align:center;border:1px solid var(--border);
      box-shadow:0 30px 80px rgba(15,23,42,0.18);
    }
    .thank-code{font-weight:900;font-size:20px;color:var(--primary);margin:10px 0}
    .thank-sub{color:var(--muted);font-size:13px}
    .thank-actions{display:flex;gap:10px;justify-content:center;margin-top:14px;flex-wrap:wrap}

    /* RESPONSIVE SWITCH */
    @media(max-width:900px){
      .page{grid-template-columns:1fr;gap:14px}
      .table-wrap{display:none}
      .cards-grid{display:grid}
      .cards-grid .order-card{display:block}
    }
    @media(min-width:901px){
      .cards-grid{display:none}
      .table-wrap{display:block}
    }

    /* small helpers */
    .muted{color:var(--muted);font-size:13px}
    .badge{display:inline-block;padding:6px 8px;border-radius:999px;background:#f3f4f6;font-size:12px}
    .input-inline{display:inline-flex;gap:6px;align-items:center}
    .footnote{font-size:12px;color:var(--muted);margin-top:10px}
    .danger{background:#fff;border:1px solid #fecaca;color:#b91c1c}
    :focus{outline:3px solid rgba(209,0,7,0.12);outline-offset:2px}
  </style>
</head>
<body>
  <!-- HEADER (Homepage style) -->
  <nav class="navbar" id="navbar">
    <div class="nav-container">
      <div class="nav-logo" onclick="location.href='index.html'">
        <div class="logo-img">PG</div>
        <span class="logo-text">Prabha Graphics</span>
      </div>

      <ul class="nav-links" id="navLinks" aria-hidden="true">
        <li><a href="index.html" class="nav-link">Home</a></li>
        <li><a href="about.html" class="nav-link">About Us</a></li>
        <li><a href="products.html#corporate" class="nav-link">Corporate Gifts</a></li>
        <li><a href="products.html#personalized" class="nav-link">Personalized Gifts</a></li>
        <li><a href="contact-us.html" class="nav-link">Contact Us</a></li>
      </ul>

      <div style="display:flex;gap:12px;align-items:center">
        <button class="cta-btn" onclick="location.href='products.html'">View Store</button>
        <div class="hamburger" id="hamburger" aria-hidden="true">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>
  </nav>

  <main class="page" role="main">
    <!-- LEFT: Orders area -->
    <section>
      <div class="card">
        <div class="card-header">
          <div>
            <div class="title">Orders Management</div>
            <div class="sub">Realtime orders (collection: <code>orders</code>) — search, filter, update status, view order number & add tracking</div>
          </div>

          <!-- AUTH BAR -->
          <div class="auth-strip" id="authBar">
            <input id="adminEmail" class="auth-input" type="email" placeholder="admin@example.com" />
            <input id="adminPassword" class="auth-input" type="password" placeholder="Password" />
            <button id="signInBtn" class="btn-auth primary"><i class="fas fa-lock-open"></i>&nbsp; Sign in</button>
            <button id="signOutBtn" class="btn-auth secondary" style="display:none"><i class="fas fa-right-from-bracket"></i>&nbsp; Sign out</button>
          </div>
        </div>

        <!-- FILTERS -->
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px">
          <div class="filters" style="flex:1">
            <input id="searchInput" type="text" placeholder="Search orders by order#, product, customer, phone or SKU" />
            <select id="statusFilter" class="small">
              <option value="">All statuses</option>
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="shipped">Shipped</option>
              <option value="completed">Completed</option>
            </select>
            <label class="small muted" style="display:inline-flex;align-items:center;gap:6px">
              From <input id="fromDate" type="date" style="padding:6px;border-radius:8px;border:1px solid var(--border)"/>
            </label>
            <label class="small muted" style="display:inline-flex;align-items:center;gap:6px">
              To <input id="toDate" type="date" style="padding:6px;border-radius:8px;border:1px solid var(--border)"/>
            </label>
            <button id="clearFilters" class="btn small ghost">Clear</button>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <span id="ordersCount" class="badge">— orders</span>
            <button id="refreshBtn" class="btn small ghost"><i class="fas fa-sync"></i> Refresh</button>
          </div>
        </div>

        <!-- TABLE VIEW (desktop) -->
        <div class="table-wrap card" aria-hidden="false">
          <table aria-label="Orders table">
            <thead>
              <tr>
                <th style="min-width:160px">Order # / Date</th>
                <th>Product</th>
                <th>Customer</th>
                <th>Address</th>
                <th>Status</th>
                <th style="min-width:160px">Amount / Qty</th>
                <th style="min-width:220px">Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTableBody">
              <tr><td colspan="7" class="muted">Loading orders…</td></tr>
            </tbody>
          </table>
        </div>

        <!-- CARDS VIEW (mobile) -->
        <div class="cards-grid" id="ordersCards"></div>

        <div class="footnote">Tip: Click an order's "Details" to open full information, view the full order number and add tracking number.</div>
      </div>
    </section>

    <!-- RIGHT: quick panels -->
    <aside>
      <div class="card panel-section">
        <div class="card-header">
          <div><div class="title">Quick actions</div><div class="sub">Common tasks</div></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="markAllProcessing" class="btn small primary"><i class="fas fa-spinner"></i> Mark all pending → processing</button>
          <button id="markAllShipped" class="btn small secondary"><i class="fas fa-truck"></i> Mark all processing → shipped</button>
          <button id="deleteTestOrders" class="btn small danger"><i class="fas fa-trash"></i> Delete test orders (match "test" phone/name)</button>
        </div>
      </div>

      <div class="card panel-section">
        <div class="card-header"><div><div class="title">Recent activity</div><div class="sub">Latest orders & changes</div></div></div>
        <div id="activityList" class="panel-scroll"></div>
      </div>

      <div class="card panel-section">
        <div class="card-header"><div><div class="title">Collections used</div><div class="sub">Read/write</div></div></div>
        <div class="muted">orders • products • contactMessages • quotes</div>
      </div>
    </aside>
  </main>

  <!-- ORDER DETAIL MODAL -->
  <div id="detailModal" class="modal-bg" role="dialog" aria-hidden="true">
    <div class="modal" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div>
          <h3 id="modalTitle" style="margin:0">Order details</h3>
          <div id="modalMeta" class="muted">—</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="modalClose" class="btn ghost small"><i class="fas fa-times"></i> Close</button>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px">
        <div>
          <div id="modalOrderNumber" style="font-weight:800;font-size:16px;color:var(--primary)"></div>
          <div id="modalProduct" style="font-weight:700;font-size:15px;margin-top:8px"></div>
          <div id="modalSKU" class="muted" style="margin-top:6px"></div>
          <div id="modalNote" style="margin-top:10px"></div>

          <div class="muted" style="margin-top:12px">Customer</div>
          <div id="modalCustomer" style="margin-top:6px"></div>

          <div class="muted" style="margin-top:12px">Address</div>
          <div id="modalAddress" style="margin-top:6px"></div>

          <div class="muted" style="margin-top:12px">Order snapshot / extras</div>
          <pre id="modalSnapshot" style="background:#fbfbfb;padding:8px;border-radius:8px;font-size:13px;overflow:auto;max-height:220px"></pre>
        </div>

        <div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div>
              <div class="muted">Status</div>
              <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
                <button class="btn small" data-set-status="pending">Pending</button>
                <button class="btn small" data-set-status="processing">Processing</button>
                <button class="btn small" data-set-status="shipped">Shipped</button>
                <button class="btn small" data-set-status="completed">Completed</button>
              </div>
            </div>

            <div>
              <label class="muted">Tracking number (optional)</label>
              <input id="trackingInput" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);margin-top:6px" placeholder="Enter tracking / AWB number" />
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="saveTrackingBtn" class="btn primary small">Save tracking</button>
                <button id="openWhatsappBtn" class="btn ghost small"><i class="fab fa-whatsapp"></i> Notify on WhatsApp</button>
              </div>
            </div>

            <div>
              <div class="muted">Amount</div>
              <div id="modalAmount" style="font-weight:700;margin-top:6px"></div>
            </div>

            <div>
              <div class="muted">Placed at</div>
              <div id="modalPlaced" style="margin-top:6px"></div>
            </div>

            <div>
              <div class="muted">Actions</div>
              <div style="display:flex;gap:8px;margin-top:6px">
                <button id="deleteOrderBtn" class="btn danger small"><i class="fas fa-trash"></i> Delete order</button>
                <button id="copyInfoBtn" class="btn ghost small"><i class="fas fa-copy"></i> Copy summary</button>
                <button id="copyOrderNumberBtn" class="btn small"><i class="fas fa-link"></i> Copy order #</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- THANK YOU POPUP (Option A: popup replaces redirect) -->
  <div id="thankModal" class="modal-bg thank-modal" aria-hidden="true" role="dialog">
    <div class="box">
      <div style="font-size:22px;font-weight:800">Thank you — order received</div>
      <div class="thank-sub" style="margin-top:8px">We've received your order. Your order reference is:</div>
      <div class="thank-code" id="thankOrderNumber">PG-2025-000123</div>
      <div class="thank-sub" style="margin-top:6px" id="thankShort">You'll get a confirmation on WhatsApp / SMS shortly.</div>
      <div class="thank-actions">
        <button id="thankCopy" class="btn small"><i class="fas fa-copy"></i> Copy order #</button>
        <button id="thankWhats" class="btn ghost small"><i class="fab fa-whatsapp"></i> Open WhatsApp</button>
        <button id="thankClose" class="btn small"><i class="fas fa-check"></i> Close</button>
      </div>
    </div>
  </div>

  <!-- FOOTER (homepage style) -->
  <footer class="card" style="max-width:1280px;margin:28px auto 60px;padding:26px">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="logo-img" style="width:44px;height:44px;border-radius:50%;">PG</div>
        <div>
          <div style="font-weight:700">Prabha Graphics</div>
          <div class="muted" style="font-size:13px">Corporate & personalized gifts — Lucknow</div>
        </div>
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <a href="https://www.instagram.com/prabhagraphics/" class="badge" target="_blank">Instagram</a>
        <a href="https://www.youtube.com/@prabhagraphics3043" class="badge" target="_blank">YouTube</a>
      </div>
    </div>
    <div style="margin-top:12px;color:var(--muted);font-size:13px">&copy; 2025 Prabha Graphics. All rights reserved.</div>
  </footer>

  <script type="module">
    // Firebase imports & config
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot,
      doc, updateDoc, deleteDoc, serverTimestamp, getDoc, runTransaction, addDoc
    } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCADm7aarTkJ4Hohsb2xz1EkqrkLWjSQxg",
      authDomain: "my-project-b3537.firebaseapp.com",
      projectId: "my-project-b3537",
      storageBucket: "my-project-b3537.firebasestorage.app",
      messagingSenderId: "652581310060",
      appId: "1:652581310060:web:c00691e1c625e1a78ad249",
      measurementId: "G-CG17J3F6YW"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const adminEmail = document.getElementById('adminEmail');
    const adminPassword = document.getElementById('adminPassword');
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const authBar = document.getElementById('authBar');

    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    const ordersCount = document.getElementById('ordersCount');
    const refreshBtn = document.getElementById('refreshBtn');
    const clearFilters = document.getElementById('clearFilters');

    const ordersTableBody = document.getElementById('ordersTableBody');
    const ordersCards = document.getElementById('ordersCards');
    const activityList = document.getElementById('activityList');

    // modal refs
    const detailModal = document.getElementById('detailModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMeta = document.getElementById('modalMeta');
    const modalProduct = document.getElementById('modalProduct');
    const modalSKU = document.getElementById('modalSKU');
    const modalNote = document.getElementById('modalNote');
    const modalCustomer = document.getElementById('modalCustomer');
    const modalAddress = document.getElementById('modalAddress');
    const modalSnapshot = document.getElementById('modalSnapshot');
    const modalAmount = document.getElementById('modalAmount');
    const modalPlaced = document.getElementById('modalPlaced');
    const trackingInput = document.getElementById('trackingInput');
    const saveTrackingBtn = document.getElementById('saveTrackingBtn');
    const openWhatsappBtn = document.getElementById('openWhatsappBtn');
    const deleteOrderBtn = document.getElementById('deleteOrderBtn');
    const copyInfoBtn = document.getElementById('copyInfoBtn');
    const modalClose = document.getElementById('modalClose');
    const modalOrderNumber = document.getElementById('modalOrderNumber');
    const copyOrderNumberBtn = document.getElementById('copyOrderNumberBtn');

    // thank you modal refs (used on product page submission flow if reused)
    const thankModal = document.getElementById('thankModal');
    const thankOrderNumber = document.getElementById('thankOrderNumber');
    const thankCopy = document.getElementById('thankCopy');
    const thankWhats = document.getElementById('thankWhats');
    const thankClose = document.getElementById('thankClose');

    // state
    let unsubOrders = null;
    let ordersCache = {}; // id -> order
    let currentOrderId = null;

    // --- Auth handlers ---
    signInBtn.addEventListener('click', async () => {
      const e = adminEmail.value.trim();
      const p = adminPassword.value;
      if (!e || !p) return alert('Enter email and password');
      try {
        await signInWithEmailAndPassword(auth, e, p);
      } catch(err) {
        console.error('signin', err);
        alert('Sign-in failed: ' + (err.message || err));
      }
    });
    signOutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, user => {
      if (user) {
        signInBtn.style.display = 'none';
        signOutBtn.style.display = 'inline-flex';
        adminEmail.style.display = 'none';
        adminPassword.style.display = 'none';
        startOrdersListener();
      } else {
        signInBtn.style.display = 'inline-flex';
        signOutBtn.style.display = 'none';
        adminEmail.style.display = '';
        adminPassword.style.display = '';
        stopOrdersListener();
      }
    });

    // --- Realtime orders listener ---
    function startOrdersListener(){
      if (unsubOrders) return;
      const q = query(collection(db,'orders'), orderBy('createdAt','desc'));
      unsubOrders = onSnapshot(q, snap => {
        ordersCache = {};
        const rows = [];
        snap.forEach(s => {
          const d = s.data(); d.id = s.id;
          ordersCache[s.id] = d;
          rows.push({ id: s.id, data: d });
        });
        renderOrders(rows);
        renderActivity(rows.slice(0,8));
      }, err => {
        console.error('orders snapshot error', err);
      });
    }
    function stopOrdersListener(){
      if (unsubOrders){ unsubOrders(); unsubOrders = null; }
      ordersTableBody.innerHTML = '';
      ordersCards.innerHTML = '';
      activityList.innerHTML = '';
      ordersCount.textContent = '— orders';
    }

    // --- Render functions ---
    function renderOrders(rows){
      // Apply filters & search
      const q = (searchInput.value || '').trim().toLowerCase();
      const st = (statusFilter.value || '').toLowerCase();
      const from = fromDate.value ? new Date(fromDate.value) : null;
      const to = toDate.value ? new Date(toDate.value) : null;
      if (to) to.setHours(23,59,59,999);

      const filtered = rows.filter(r => {
        const o = r.data;
        // dates
        const created = o.createdAt && o.createdAt.toDate ? o.createdAt.toDate() : (o.createdAt ? new Date(o.createdAt) : null);
        if (from && created && created < from) return false;
        if (to && created && created > to) return false;
        // status
        if (st && String((o.status||'')).toLowerCase() !== st) return false;
        // search on orderNumber, productName, customerName, phone, sku
        if (!q) return true;
        const hay = [
          o.orderNumber||'',
          o.productName||'',
          o.customerName||'',
          o.customerPhone||'',
          (o.productSnapshot && o.productSnapshot.sku) || '',
          (o.note || ''),
          String(o.totalAmount || '')
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });

      ordersCount.textContent = `${filtered.length} orders`;
      renderTable(filtered);
      renderCards(filtered);
    }

    function fmtDate(ts){
      if (!ts) return '-';
      const d = (ts.toDate ? ts.toDate() : (ts.seconds ? new Date(ts.seconds*1000) : new Date(ts)));
      return new Intl.DateTimeFormat('en-IN',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}).format(d);
    }

    function statusPill(status){
      const cls = {
        pending: 'status-pending',
        processing: 'status-processing',
        shipped: 'status-shipped',
        completed: 'status-completed'
      }[status] || 'status-pending';
      return `<span class="status-pill ${cls}">${escapeHtml(status || 'pending')}</span>`;
    }

    function renderTable(rows){
      if (!ordersTableBody) return;
      ordersTableBody.innerHTML = '';
      if (!rows.length){
        ordersTableBody.innerHTML = `<tr><td colspan="7" class="muted">No orders match filters.</td></tr>`;
        return;
      }

      rows.forEach(r => {
        const o = r.data;
        const id = r.id;
        const created = fmtDate(o.createdAt);
        const orderNumber = o.orderNumber ? escapeHtml(o.orderNumber) : escapeHtml(id.slice(0,8));
        const product = escapeHtml(o.productName || (o.productSnapshot && o.productSnapshot.name) || '—');
        const sku = escapeHtml(o.productSnapshot && o.productSnapshot.sku || '—');
        const customer = `<div style="font-weight:600">${escapeHtml(o.customerName || '')}</div><div class="muted">${escapeHtml(o.customerPhone||'')}</div>`;
        const addrParts = [];
        const a = o.address || {};
        if (a.line1) addrParts.push(escapeHtml(a.line1));
        if (a.city) addrParts.push(escapeHtml(a.city));
        if (a.state) addrParts.push(escapeHtml(a.state));
        const addr = addrParts.join(', ') || '<span class="muted">No address</span>';
        const statusHtml = statusPill(o.status);
        const amountQty = `₹${Number(o.totalAmount||0).toLocaleString('en-IN')} • Qty: ${o.quantity || 1}`;

        const actions = `
          <div class="actions">
            <button class="btn small" data-id="${id}" data-action="details"><i class="fas fa-eye"></i> Details</button>
            <button class="btn small" data-id="${id}" data-action="set-processing">Processing</button>
            <button class="btn small" data-id="${id}" data-action="set-shipped">Shipped</button>
            <button class="btn small danger" data-id="${id}" data-action="delete"><i class="fas fa-trash"></i> Delete</button>
          </div>
        `;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><div style="font-weight:700">${orderNumber}</div><div class="muted">${created}</div></td>
          <td>${product}<div class="muted" style="margin-top:6px">${sku}</div></td>
          <td>${customer}</td>
          <td>${addr}</td>
          <td>${statusHtml}</td>
          <td><div style="font-weight:700">${amountQty}</div><div class="muted" style="margin-top:6px">Payment: ${escapeHtml(o.paymentMethod||'-')}</div></td>
          <td>${actions}</td>
        `;
        ordersTableBody.appendChild(tr);
      });

      // delegate action buttons
      ordersTableBody.querySelectorAll('button').forEach(btn => {
        btn.onclick = handleTableAction;
      });
    }

    function renderCards(rows){
      if (!ordersCards) return;
      ordersCards.innerHTML = '';
      rows.forEach(r => {
        const o = r.data; const id = r.id;
        const created = fmtDate(o.createdAt);
        const orderNumber = o.orderNumber || id.slice(0,8);
        const product = escapeHtml(o.productName || (o.productSnapshot && o.productSnapshot.name) || '—');
        const sku = escapeHtml(o.productSnapshot && o.productSnapshot.sku || '—');
        const addr = [o.address && o.address.line1, o.address && o.address.city].filter(Boolean).join(', ') || 'No address';
        const amount = `₹${Number(o.totalAmount||0).toLocaleString('en-IN')}`;

        const div = document.createElement('div');
        div.className = 'order-card';
        div.innerHTML = `
          <div class="order-top">
            <div class="order-left">
              <div style="font-weight:700">${product}</div>
              <div class="muted" style="margin-top:6px">${sku} • ${created}</div>
              <div style="margin-top:8px">${escapeHtml(o.customerName||'')} • ${escapeHtml(o.customerPhone||'')}</div>
              <div class="muted" style="margin-top:6px">${escapeHtml(addr)}</div>
              <div style="margin-top:8px;color:var(--primary);font-weight:700">${escapeHtml(orderNumber)}</div>
            </div>
            <div class="order-right">
              ${statusPill(o.status)}
              <div style="margin-top:8px;font-weight:700">${amount}</div>
              <div class="muted" style="margin-top:6px">Qty: ${o.quantity || 1}</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="btn small" data-id="${id}" data-action="details">Details</button>
            <button class="btn small" data-id="${id}" data-action="set-shipped">Shipped</button>
            <button class="btn small danger" data-id="${id}" data-action="delete">Delete</button>
          </div>
        `;
        ordersCards.appendChild(div);
      });

      ordersCards.querySelectorAll('button').forEach(b=> b.onclick = handleTableAction);
    }

    function renderActivity(rows){
      if (!activityList) return;
      activityList.innerHTML = '';
      rows.slice(0,8).forEach(r=>{
        const o = r.data;
        const id = r.id;
        const el = document.createElement('div');
        el.className = 'order-card';
        el.style.padding = '8px';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:600">${escapeHtml(o.productName || 'Order')}</div>
            <div class="muted">${fmtDate(o.createdAt)}</div>
          </div>
          <div class="muted" style="margin-top:6px">${escapeHtml(o.customerName||'')} • ${escapeHtml(o.customerPhone||'')}</div>
        `;
        activityList.appendChild(el);
      });
    }

    // --- actions handler for table and cards ---
    async function handleTableAction(e){
      const id = e.currentTarget.dataset.id;
      const act = e.currentTarget.dataset.action;
      if (!id) return;
      if (act === 'details') return openDetail(id);
      if (act === 'set-processing') return updateStatus(id, 'processing');
      if (act === 'set-shipped') return updateStatus(id, 'shipped');
      if (act === 'delete') {
        if (!confirm('Delete this order?')) return;
        try{ await deleteDoc(doc(db,'orders',id)); alert('Deleted'); } catch(err){ alert('Delete failed: '+(err.message||err)); }
      }
    }

    // --- detail modal ---
    function openDetail(id){
      const o = ordersCache[id];
      if (!o) return alert('Order not found');
      currentOrderId = id;
      modalTitle.textContent = `Order ${o.orderNumber ? o.orderNumber : id.slice(0,8)}`;
      modalMeta.textContent = `${fmtDate(o.createdAt)} • ${escapeHtml(o.status || 'pending')}`;
      modalOrderNumber.textContent = o.orderNumber ? `Order #: ${o.orderNumber}` : `Order ID: ${id}`;
      modalProduct.textContent = o.productName || (o.productSnapshot && o.productSnapshot.name) || '-';
      modalSKU.textContent = 'SKU: ' + (o.productSnapshot && o.productSnapshot.sku || '-');
      modalNote.textContent = o.note ? `Note: ${o.note}` : '';
      modalCustomer.innerHTML = `${escapeHtml(o.customerName||'')}<div class="muted">${escapeHtml(o.customerPhone||'')}</div><div class="muted">${escapeHtml(o.customerEmail||'')}</div>`;
      const addr = o.address || {};
      modalAddress.innerHTML = `${escapeHtml(addr.line1||'')} ${addr.line2?('<div class="muted">'+escapeHtml(addr.line2)+'</div>'):''}<div class="muted">${escapeHtml([addr.city,addr.state,addr.pincode].filter(Boolean).join(' • '))}</div>`;
      modalSnapshot.textContent = JSON.stringify(o.productSnapshot || {}, null, 2);
      modalAmount.textContent = `₹${Number(o.totalAmount||0).toLocaleString('en-IN')}`;
      modalPlaced.textContent = fmtDate(o.createdAt);
      trackingInput.value = o.trackingNumber || '';
      detailModal.style.display = 'flex';
      detailModal.setAttribute('aria-hidden','false');
      trapFocus(detailModal.querySelector('.modal'));
    }

    // modal close + trapFocus
    modalClose.addEventListener('click', closeDetail);
    detailModal.addEventListener('click', (e)=> { if (e.target === detailModal) closeDetail(); });
    document.addEventListener('keydown', (e)=> { if (e.key === 'Escape' && detailModal.style.display === 'flex') closeDetail(); });

    function closeDetail(){
      detailModal.style.display = 'none';
      detailModal.setAttribute('aria-hidden','true');
      currentOrderId = null;
      releaseTrap();
    }

    // modal status buttons
    detailModal.querySelectorAll('[data-set-status]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const st = btn.dataset.setStatus;
        if (!currentOrderId) return;
        await updateStatus(currentOrderId, st);
        modalMeta.textContent = `${fmtDate(ordersCache[currentOrderId].createdAt)} • ${escapeHtml(st)}`;
      });
    });

    saveTrackingBtn.addEventListener('click', async () => {
      if (!currentOrderId) return;
      const tn = trackingInput.value.trim();
      try {
        await updateDoc(doc(db,'orders',currentOrderId), { trackingNumber: tn || '', updatedAt: serverTimestamp() });
        alert('Tracking saved');
      } catch(err){ alert('Save failed: ' + (err.message||err)); }
    });

    openWhatsappBtn.addEventListener('click', () => {
      if (!currentOrderId) return;
      const o = ordersCache[currentOrderId];
      const tn = trackingInput.value.trim();
      const msg = [
        `Hi, your order ${o.orderNumber || currentOrderId} (${o.productSnapshot && o.productSnapshot.sku || '-'})`,
        `Status: ${o.status || 'pending'}`,
        tn ? `Tracking: ${tn}` : '',
        `Total: ₹${Number(o.totalAmount||0)}`,
      ].filter(Boolean).join('\n');
      const shopPhone = '917457994888';
      window.open(`https://wa.me/${shopPhone}?text=${encodeURIComponent(msg)}`, '_blank');
    });

    deleteOrderBtn.addEventListener('click', async () => {
      if (!currentOrderId) return;
      if (!confirm('Delete this order?')) return;
      try { await deleteDoc(doc(db,'orders',currentOrderId)); closeDetail(); alert('Deleted'); } catch(err){ alert('Delete failed: '+(err.message||err)); }
    });

    copyInfoBtn.addEventListener('click', () => {
      if (!currentOrderId) return;
      const o = ordersCache[currentOrderId];
      const txt = `Order ${o.orderNumber || currentOrderId}\nProduct: ${o.productName}\nQty: ${o.quantity}\nTotal: ₹${o.totalAmount}\nCustomer: ${o.customerName} • ${o.customerPhone}\nAddress: ${o.address && o.address.line1 || ''}`;
      navigator.clipboard?.writeText(txt).then(()=> alert('Copied'));
    });

    document.getElementById('copyOrderNumberBtn')?.addEventListener('click', ()=> {
      if (!currentOrderId) return;
      const o = ordersCache[currentOrderId];
      const num = o.orderNumber || currentOrderId;
      navigator.clipboard?.writeText(num).then(()=> alert('Order number copied'));
    });

    // --- status update helper ---
    async function updateStatus(id, status){
      try {
        await updateDoc(doc(db,'orders',id), { status, updatedAt: serverTimestamp() });
        alert('Status updated to ' + status);
      } catch(err){ alert('Update failed: '+(err.message||err)); }
    }

    // --- quick actions ---
    document.getElementById('markAllProcessing').addEventListener('click', async () => {
      if (!confirm('Mark all pending orders as processing?')) return;
      const batchIds = Object.keys(ordersCache).filter(id => (ordersCache[id].status||'') === 'pending').slice(0,200);
      for (const id of batchIds){
        try { await updateDoc(doc(db,'orders',id), { status: 'processing', updatedAt: serverTimestamp() }); } catch(e){ console.error(e); }
      }
      alert('Requested updates to processing for ' + batchIds.length + ' orders (firestore updates completed).');
    });
    document.getElementById('markAllShipped').addEventListener('click', async () => {
      if (!confirm('Mark all processing orders as shipped?')) return;
      const batchIds = Object.keys(ordersCache).filter(id => (ordersCache[id].status||'') === 'processing').slice(0,200);
      for (const id of batchIds){
        try { await updateDoc(doc(db,'orders',id), { status: 'shipped', updatedAt: serverTimestamp() }); } catch(e){ console.error(e); }
      }
      alert('Requested updates to shipped for ' + batchIds.length + ' orders.');
    });
    document.getElementById('deleteTestOrders').addEventListener('click', async () => {
      if (!confirm('Delete orders where customer name or phone contains "test"?')) return;
      const toDelete = Object.keys(ordersCache).filter(id => {
        const o = ordersCache[id]; const n = (o.customerName||'').toLowerCase(); const p = (o.customerPhone||'').toLowerCase();
        return n.includes('test') || p.includes('test');
      });
      for (const id of toDelete){ try { await deleteDoc(doc(db,'orders',id)); } catch(e){ console.error(e); } }
      alert('Deleted ' + toDelete.length + ' test orders (if any).');
    });

    document.getElementById('viewStoreBtn').addEventListener('click', ()=> location.href = 'products.html');

    // --- filters & search events ---
    searchInput.addEventListener('input', () => renderOrders(Object.entries(ordersCache).map(([id,data])=>({id,data}))));
    statusFilter.addEventListener('change', () => renderOrders(Object.entries(ordersCache).map(([id,data])=>({id,data}))));
    fromDate.addEventListener('change', () => renderOrders(Object.entries(ordersCache).map(([id,data])=>({id,data}))));
    toDate.addEventListener('change', () => renderOrders(Object.entries(ordersCache).map(([id,data])=>({id,data}))));
    clearFilters.addEventListener('click', ()=> {
      searchInput.value=''; statusFilter.value=''; fromDate.value=''; toDate.value=''; renderOrders(Object.entries(ordersCache).map(([id,data])=>({id,data})));
    });
    refreshBtn.addEventListener('click', ()=> {
      // re-render from cache (the onSnapshot will keep it fresh)
      renderOrders(Object.entries(ordersCache).map(([id,data])=>({id,data})));
    });

    // --- focus trap for modal ---
    let _trap = null;
    function trapFocus(container){
      releaseTrap();
      const focusable = container.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
      if (!focusable.length) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      _trap = function(e){
        if (e.key === 'Tab'){
          if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
          else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
        }
      };
      container.addEventListener('keydown', _trap);
      setTimeout(()=> first && first.focus(), 50);
    }
    function releaseTrap(){
      if (!_trap) return;
      document.removeEventListener('keydown', _trap);
      _trap = null;
    }

    // --- util ---
    function escapeHtml(s=''){ return String(s===null||s===undefined?'':s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

    // initial no-auth message: show hint
    ordersTableBody.innerHTML = `<tr><td colspan="7" class="muted">Sign in to view orders. Use the admin email & password.</td></tr>`;

    // ---------------- Additional utilities for order creation (used by product page) ----------------
    // This code demonstrates how to create an order and generate a readable sequential order number:
    // - Creates / increments a counter in doc "meta/counters" field "ordersSeq" using runTransaction (atomic)
    // - Uses the returned sequence to form: PG-<YYYY>-<6-digit-seq>
    //
    // Example usage (from product page when user submits an order):
    //   const createdOrder = await createOrderWithNumber(orderPayload);
    //   // createdOrder contains { id, orderNumber, ... }
    //
    async function createOrderWithNumber(orderPayload){
      // orderPayload: object representing the order fields (customer, productSnapshot, totalAmount, etc.)
      // We will:
      //  1) atomically increment a counter (under `meta/counters` doc)
      //  2) use the new sequence to build orderNumber
      //  3) write the order doc with orderNumber & createdAt serverTimestamp
      const metaRef = doc(db, 'meta', 'counters');
      try {
        const result = await runTransaction(db, async (tx) => {
          const metaSnap = await tx.get(metaRef);
          let seq = 1;
          if (!metaSnap.exists()) {
            tx.set(metaRef, { ordersSeq: 1 }, { merge: true });
            seq = 1;
          } else {
            const data = metaSnap.data() || {};
            const cur = Number(data.ordersSeq || 0);
            seq = cur + 1;
            tx.update(metaRef, { ordersSeq: seq });
          }
          // build order number
          const now = new Date();
          const year = now.getFullYear();
          const padded = String(seq).padStart(6, '0');
          const orderNumber = `PG-${year}-${padded}`;

          // assemble final order object
          const final = {
            ...orderPayload,
            orderNumber,
            status: orderPayload.status || 'pending',
            createdAt: serverTimestamp()
          };

          // create order doc
          const ordersCol = collection(db, 'orders');
          // We can't use tx.set on addDoc result inside transaction easily — instead return needed values and write outside tx
          return { orderNumber, final, /* seq returned for reference */ seq };
        });

        // outside transaction add the order doc (we intentionally keep sequence increment inside tx; write can be outside)
        const ordersCol = collection(db, 'orders');
        const added = await addDoc(ordersCol, { ...result.final });
        // attach Firestore doc id to returned object
        return { id: added.id, orderNumber: result.orderNumber };
      } catch (err) {
        console.error('createOrderWithNumber error', err);
        throw err;
      }
    }

    // Provide quick helpers for thank-you modal (used by product page)
    // Example call from product page after successful createOrderWithNumber:
    //   showThankYou(orderNumber, shortMessage, whatsappTextIfNeeded)
    function showThankYou(orderNumber, shortText = 'You will receive a confirmation shortly.', waText = null){
      if (!thankModal) return;
      thankOrderNumber.textContent = orderNumber;
      document.getElementById('thankShort').textContent = shortText;
      thankModal.style.display = 'flex';
      thankModal.setAttribute('aria-hidden','false');
      // copy button
      thankCopy.onclick = ()=> {
        navigator.clipboard?.writeText(orderNumber).then(()=> alert('Order number copied'));
      };
      thankWhats.onclick = () => {
        if (!waText) {
          // open simple generic message
          waText = `Hi, I submitted an order on your website. Order #: ${orderNumber}`;
        }
        const shopPhone = '917457994888';
        window.open(`https://wa.me/${shopPhone}?text=${encodeURIComponent(waText)}`, '_blank');
      };
      thankClose.onclick = () => {
        thankModal.style.display = 'none';
        thankModal.setAttribute('aria-hidden','true');
      };
      // allow background click to close
      thankModal.addEventListener('click', (e) => { if (e.target === thankModal) { thankModal.style.display='none'; thankModal.setAttribute('aria-hidden','true'); } });
      trapFocus(thankModal.querySelector('.box') || thankModal.querySelector('.modal'));
    }

    // ---------------- Navbar mobile toggle ----------------
    document.getElementById('hamburger').addEventListener('click', function(){
      const nav = document.getElementById('navLinks');
      if (!nav) return;
      nav.classList.toggle('active');
      const expanded = nav.classList.contains('active');
      this.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    });

    console.log('Orders management page loaded — full copy-paste ready.');
  </script>
</body>
</html>
